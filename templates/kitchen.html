{% extends "base.html" %}

{% block title %}주방 화면{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>주방 화면</h2>
        <div class="d-flex align-items-center">
            <span class="me-3">관리자: {{ username }}</span>
            <a href="/admin/logout" class="btn btn-outline-secondary btn-sm">로그아웃</a>
        </div>
    </div>

    <div class="row">
        <!-- 조리 중인 주문 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">조리 중인 주문</h3>
                </div>
                <div class="card-body" id="cookingOrders">
                    {% if cooking_orders %}
                        {% for order in cooking_orders %}
                        <div class="card mb-3" id="order-{{ order.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title">테이블 {{ order.table_id }}</h5>
                                        <p class="card-text">
                                            <small class="text-muted">주문 시간: {{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                        </p>
                                        <ul class="list-unstyled">
                                            {% for menu_id, quantity in order.menu.items() %}
                                            <li>{{ menu_names[menu_id] }} × {{ quantity }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <form method="POST" action="/kitchen/update-status/{{ order.id }}">
                                        <input type="hidden" name="status" value="completed">
                                        <button type="submit" class="btn btn-success">조리 완료</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            조리 중인 주문이 없습니다.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 완료된 주문 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">완료된 주문</h3>
                </div>
                <div class="card-body" id="completedOrders">
                    {% if completed_orders %}
                        {% for order in completed_orders %}
                        <div class="card mb-3" id="completed-{{ order.id }}">
                            <div class="card-body">
                                <h5 class="card-title">테이블 {{ order.table_id }}</h5>
                                <p class="card-text">
                                    <small class="text-muted">완료 시간: {{ order.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                </p>
                                <ul class="list-unstyled">
                                    {% for menu_id, quantity in order.menu.items() %}
                                    <li>{{ menu_names[menu_id] }} × {{ quantity }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            완료된 주문이 없습니다.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="/admin/orders" class="btn btn-primary">결제 대기 주문</a>
        <a href="/admin/menu" class="btn btn-primary ms-2">메뉴 관리</a>
    </div>
</div>

<script>
// WebSocket 연결 설정
const ws = new WebSocket(`ws://${window.location.host}/ws`);

// 소리 알림 설정
const notificationSound = new Audio('/static/notification.mp3');

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    if (data.type === 'new_order') {
        // 소리 알림 재생
        notificationSound.play();
        
        // 브라우저 알림 표시
        if (Notification.permission === "granted") {
            new Notification("새 주문", {
                body: `테이블 ${data.table_id}에서 ${data.amount}원 주문이 들어왔습니다.`,
                icon: "/static/logo.png"
            });
        }
        
        // 페이지 새로고침
        location.reload();
    }
};

// 브라우저 알림 권한 요청
if (Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
}
</script>
{% endblock %} 