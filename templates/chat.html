{% extends "base.html" %}

{% block title %}ë™ìˆ ë™ìˆ  ì±„íŒ…{% endblock %}

{% block extra_css %}
<!-- ì±„íŒ… ê´€ë ¨ ìŠ¤íƒ€ì¼ì€ style.cssì— í¬í•¨ë¨ -->
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/chat.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container" id="chat-container"{% if table_id %} data-table-id="{{ table_id }}"{% endif %}>
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="bi bi-chat-dots me-2"></i>ë™ìˆ ë™ìˆ  ì±„íŒ…ë°©
            </h2>
            
            <!-- í…Œì´ë¸” ë²ˆí˜¸ ì…ë ¥ (URLì— table_idê°€ ì—†ëŠ” ê²½ìš°) -->
            {% if not table_id %}
            <div class="welcome-message">
                <h4>ğŸŒŸ í™˜ì˜í•©ë‹ˆë‹¤! ğŸŒŸ</h4>
                <p>ë‹¤ë¥¸ í…Œì´ë¸”ê³¼ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì–´ ë³´ì„¸ìš”!</p>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="number" id="table-number-input" class="form-control" 
                                   placeholder="í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-50)" min="1" max="50">
                            <button class="btn btn-primary" onclick="joinChat()">
                                <i class="bi bi-door-open me-1"></i>ì…ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            
            <!-- ì˜¨ë¼ì¸ ì‚¬ìš©ì ëª©ë¡ -->
            <div class="online-users">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <strong><i class="bi bi-people me-1"></i>í˜„ì¬ ì ‘ì† ì¤‘ì¸ í…Œì´ë¸”</strong>
                    <div>
                        <small id="online-count">0ëª…</small>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleOrderModal()">
                            <i class="bi bi-gift me-1"></i>ì£¼ë¬¸í•˜ê¸°
                        </button>
                    </div>
                </div>
                <div id="online-users-list">
                    <div class="loading">ì ‘ì†ìë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
                </div>
            </div>
            
            <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
            <div class="chat-container">
                <div id="chat-status" class="chat-status" style="display: none;">
                    ì—°ê²° ì¤‘...
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="loading">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
                
                <div class="chat-input-container">
                    <!-- ë‹‰ë„¤ì„ ì„¤ì • -->
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <i class="bi bi-person"></i>
                                </span>
                                <input type="text" id="nickname-input" class="form-control" 
                                       placeholder="ë‹‰ë„¤ì„ (ì„ íƒì‚¬í•­)" maxlength="20">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                í˜„ì¬: <span id="current-table">í…Œì´ë¸”{{ table_id }}</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- ë©”ì‹œì§€ ì…ë ¥ -->
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" 
                               placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
                        <button class="btn btn-primary" id="send-button" onclick="sendMessage()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ì£¼ë¬¸ ëª¨ë‹¬ -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">
                    <i class="bi bi-gift me-2"></i>ë‹¤ë¥¸ í…Œì´ë¸”ì— ì£¼ë¬¸í•˜ê¸°
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ë‹¨ê³„ 1: í…Œì´ë¸” ì„ íƒ -->
                <div id="step-select-table" class="order-step">
                    <h6 class="mb-3">ì£¼ë¬¸ë°›ì„ í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”</h6>
                    <div class="row" id="table-selection">
                        <div class="col-12 text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">í…Œì´ë¸” ëª©ë¡ ë¡œë”© ì¤‘...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ë‹¨ê³„ 2: ë©”ë‰´ ì„ íƒ -->
                <div id="step-select-menu" class="order-step" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">ë©”ë‰´ ì„ íƒ</h6>
                        <span id="selected-table-info" class="text-muted"></span>
                    </div>
                    <div id="menu-categories">
                        <!-- ë©”ë‰´ ì¹´í…Œê³ ë¦¬ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <!-- ì£¼ë¬¸ ìš”ì•½ -->
                    <div class="mt-4">
                        <h6>ì£¼ë¬¸ ìš”ì•½</h6>
                        <div id="order-summary" class="border rounded p-3">
                            <p class="text-muted mb-0">ì•„ì§ ì„ íƒëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="mt-2">
                            <strong>ì´ ê¸ˆì•¡: <span id="total-amount">0</span>ì›</strong>
                        </div>
                    </div>
                </div>
                
                <!-- ë‹¨ê³„ 3: ë©”ì‹œì§€ ì…ë ¥ -->
                <div id="step-add-message" class="order-step" style="display: none;">
                    <h6 class="mb-3">í•¨ê»˜ ë³´ë‚¼ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)</h6>
                    <div class="mb-3">
                        <textarea id="order-message" class="form-control" rows="3" 
                                  placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”! ë§›ìˆê²Œ ë“œì„¸ìš” ğŸ»"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        ì„ íƒí•˜ì‹  ë©”ë‰´ë¥¼ <strong id="final-table-info"></strong>ì—ê²Œ ì£¼ë¬¸í•´ë“œë¦½ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="previousStep()" id="prev-btn" style="display: none;">
                    <i class="bi bi-arrow-left me-1"></i>ì´ì „
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-btn">
                    ë‹¤ìŒ <i class="bi bi-arrow-right ms-1"></i>
                </button>
                <button type="button" class="btn btn-success" onclick="submitGiftOrder()" id="submit-btn" style="display: none;">
                    <i class="bi bi-check-circle me-1"></i>ì£¼ë¬¸í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    
    const container = document.getElementById('chat-container');
    console.log('Chat container element:', container);
    
    if (!container) {
        console.error('Chat container element not found');
        return;
    }
    
    const hasTableIdAttr = container.hasAttribute('data-table-id');
    console.log('Has data-table-id attribute:', hasTableIdAttr);
    
    if (hasTableIdAttr) {
        const tableId = container.getAttribute('data-table-id');
        console.log('Table ID from data attribute:', tableId);
        console.log('Table ID type:', typeof tableId);
        console.log('Table ID length:', tableId ? tableId.length : 'N/A');
        
        if (tableId && tableId.trim() !== '') {
            console.log('Calling initializeChat with table ID:', tableId);
            // í…Œì´ë¸” IDê°€ ìˆëŠ” ê²½ìš° ì±„íŒ… ì´ˆê¸°í™”
            initializeChat(tableId);
        } else {
            console.error('data-table-id attribute exists but is empty');
        }
    } else {
        console.log('No data-table-id attribute found, calling initializeTableInput');
        // í…Œì´ë¸” IDê°€ ì—†ëŠ” ê²½ìš° ì…ë ¥ í¼ ì´ˆê¸°í™”
        initializeTableInput();
    }
});
</script>
{% endblock %}
