{% extends "base.html" %}

{% block title %}주문하기 - 테이블 {{ table_id }}{% endblock %}

{% block content %}
<style>
.menu-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.menu-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.quantity-btn {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quantity-input {
    width: 60px;
    text-align: center;
    font-weight: bold;
}

.menu-image {
    height: 120px;
    object-fit: cover;
}

.menu-description {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.order-summary-item {
    transition: background-color 0.2s;
}

.order-summary-item:hover {
    background-color: #f8f9fa;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}
</style>

<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>테이블 {{ table_id }} 주문</h2>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 돌아가기
            </a>
        </div>
        
        <form id="orderForm" method="POST" action="/submit_order">
            <input type="hidden" name="table_id" value="{{ table_id }}">
            <input type="hidden" name="menu" id="menuInput">
            
            <!-- 메뉴 카테고리별 섹션 -->
            {% for category_id, category in menu_categories.items() %}
            <div class="card mb-4 animate-fade-in">
                <div class="card-header bg-light">
                    <h3 class="mb-0">{{ category.name }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for menu_id in category.items %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 menu-card">
                                <div class="row g-0">
                                    <div class="col-4">
                                        {% if menu_items[menu_id].image_filename %}
                                        <img src="/static/uploads/{{ menu_items[menu_id].image_filename }}" 
                                             class="img-fluid rounded-start menu-image" 
                                             alt="{{ menu_names[menu_id] }}">
                                        {% else %}
                                        <div class="bg-light h-100 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-8">
                                        <div class="card-body">
                                            <h5 class="card-title mb-1">{{ menu_names[menu_id] }}</h5>
                                            <p class="card-text text-primary fw-bold mb-2">{{ menu_prices[menu_id] }}원</p>
                                            {% if menu_items[menu_id].description %}
                                            <p class="menu-description">{{ menu_items[menu_id].description }}</p>
                                            {% endif %}
                                            <div class="input-group">
                                                <button type="button" class="btn btn-outline-secondary quantity-btn" 
                                                        onclick="updateQuantity('{{ menu_id }}', -1)">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="number" class="form-control quantity-input" 
                                                       id="quantity_{{ menu_id }}" value="0" min="0" readonly>
                                                <button type="button" class="btn btn-outline-secondary quantity-btn" 
                                                        onclick="updateQuantity('{{ menu_id }}', 1)">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </form>
    </div>
    
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">주문 내역</h3>
            </div>
            <div class="card-body">
                <div id="orderSummary">
                    <p class="text-muted">주문한 메뉴가 없습니다.</p>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>총 금액</h4>
                    <h4 id="totalAmount" class="text-primary">0원</h4>
                </div>
                <button type="button" class="btn btn-primary btn-lg w-100" onclick="submitOrder()" disabled id="submitButton">
                    <i class="bi bi-check-circle me-2"></i>주문하기
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let orderItems = {};
const menuPrices = {{ menu_prices|tojson }};
const menuNames = {{ menu_names|tojson }};

function updateQuantity(menuId, change) {
    const input = document.getElementById(`quantity_${menuId}`);
    const newValue = Math.max(0, parseInt(input.value) + change);
    input.value = newValue;
    
    if (newValue > 0) {
        orderItems[menuId] = newValue;
    } else {
        delete orderItems[menuId];
    }
    
    updateOrderSummary();
}

function updateOrderSummary() {
    const summary = document.getElementById('orderSummary');
    const totalAmount = document.getElementById('totalAmount');
    const submitButton = document.getElementById('submitButton');
    
    if (Object.keys(orderItems).length === 0) {
        summary.innerHTML = '<p class="text-muted">주문한 메뉴가 없습니다.</p>';
        totalAmount.textContent = '0원';
        submitButton.disabled = true;
        return;
    }
    
    let html = '<ul class="list-group">';
    let total = 0;
    
    for (const [menuId, quantity] of Object.entries(orderItems)) {
        const price = menuPrices[menuId];
        const name = menuNames[menuId];
        const itemTotal = price * quantity;
        total += itemTotal;
        
        html += [
            '<li class="list-group-item order-summary-item d-flex justify-content-between align-items-center">',
            '    <div>',
            `        <span class="badge bg-primary rounded-pill me-2">${quantity}</span>`,
            `        ${name}`,
            '    </div>',
            `    <span>${itemTotal.toLocaleString()}원</span>`,
            '</li>'
        ].join('\n');
    }
    
    html += '</ul>';
    summary.innerHTML = html;
    totalAmount.textContent = `${total.toLocaleString()}원`;
    submitButton.disabled = false;
}

function submitOrder() {
    document.getElementById('menuInput').value = JSON.stringify(orderItems);
    document.getElementById('orderForm').submit();
}
</script>
{% endblock %} 